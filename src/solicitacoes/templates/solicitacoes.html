{% extends 'menu.html' %}
{% load static %}
<style>
.file-icon {
    font-size: 24px;
    margin-right: 10px;
}

.remove-button {
   
}
</style>
{% block content %}

<div class="content-page">
    <div class="content">

        <!-- Start Content-->
        <div class="container-fluid">

            <!-- start page title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box justify-content-between d-flex align-items-md-center flex-md-row flex-column">     
                        <h4 class="page-title">Solicitações {{solicitacao.demandas}}</h4>
                        <ol class="breadcrumb m-0">
                            <li class="breadcrumb-item active">Solicitações</li>
                        </ol>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <div class="row">
               

                <div class="col-12">
                  
                    <div class="card">
                        <ul class="list-group list-group-flush">

                            <form id="form_solicitacao" method="POST"  enctype="multipart/form-data">
                            <li class="list-group-item">
                                <div class="row">
                                <div class="col-4">
                                    <div class="mb-3">
                                        <label for="titulo" class="form-label">Título: </label>
                                        <input type="text" id="titulo" name="titulo" class="form-control">
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="mb-3">
                                        <label for="prazo_entrega" class="form-label">Prazo de Entrega: </label>
                                        <input type="text" class="form-control" id="prazo_entrega" name="prazo_entrega" placeholder="Informe o vencimento" data-toggle="input-mask" data-mask-format="00/00/0000" maxlength="10">
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="mb-3">
                                        <label for="simpleinput" class="form-label">Informe o Destino:</label>
                                        <select class="form-control select2" data-toggle="select2" name="destino" id="destino">
                                            <option value="2">COTEC</option>
                                            <option value="1">EFG</option>
                                            <option value="4">BASILEU</option>
                                            <option value="3" selected>CETT</option>
                     
                                        </select>
                                    </div>
                                </div>
                                <div class="col-2">
                                    <div class="mb-3">
                                        <label for="simpleinput" class="form-label">Prioridade:</label>
                                        <select class="form-control select2" data-toggle="select2" name="prioridade" id="prioridade">
                                            <option value="1" selected>NORMAL</option>
                                            <option value="2">URGENTE</option>

                     
                                        </select>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="card border-success border">
                                        <div class="card-body">
                                            <h5 class="card-title text-success">Briefing</h5>
                                            <div class="mb-2">
                                                <textarea id="summernote" name="editordata"></textarea>
                                                
                                            </div>
                                        </div> <!-- end card-body-->
                                    </div>
                                </div>
                                <div class="col-2">
                                    <label for="fileInput" class="btn btn-info">
                                        <i class="ri-upload-cloud-line me-1"></i> Anexar Arquivos
                                      </label>
                                   
                                </div> 
                                <div class="col-8">  
                                    <input style="width: 100%;" type="file" id="fileInput" class="d-none" multiple onchange="showSelectedFiles()">
                                    <div class="row" id="fileDisplay"></div>
                                </div>
                                <div class="col-2">
                                    <button onclick="RealizaSolicitacao()" style="width: 100%;" type="button" class="btn btn-info"><i class="ri-rocket-line me-1"></i> <span>Realizar Solicitação</span> </button>
                                </div>
                            </div>
                            </li>

                            </form>
                        </ul> <!-- end list-->
                    </div> <!-- end card-->

                    <div class="col-md-12">
                        <div class="card">
                            <h5 class="card-header bg-success-subtle">Minhas Solicitações</h5>
                            <div class="card-body">
                                <form id="formFilters">
                                <div class="row">
                                    <div class="col-2">
                                        <div class="mb-3">
                                            <label for="simpleinput" class="form-label">ID:</label>
                                            <input type="text" class="form-control" name="idSolicitacao" id="idSolicitacao" placeholder="Informe o id">
                                        </div>
                                    </div>
                                <div class="col-3">
                                    <div class="mb-3">
                                        <label for="simpleinput" class="form-label">Solicitação:</label>
                                        <select class="form-control select2" data-toggle="select2" name="solicitacao" id="solicitacao" onchange="sendFilter()">
                                            <option></option>
                                            {% for solicitacao in solicitacoes %}
                                            <option value="{{solicitacao.id}}">{{solicitacao.titulo}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                <div class="col-2">
                                    <div class="mb-3">
                                        <label for="simpleinput" class="form-label">Data da Solicitação:</label>
                                        <input type="text" class="form-control" placeholder="Informe o vencimento" name="data_solicitacao" id="data_solicitacao" data-toggle="input-mask" data-mask-format="00/00/0000" maxlength="10">
                                    </div>
                                </div>

                                <div class="col-2">
                                    <div class="mb-3">
                                        <label for="simpleinput" class="form-label">Setor:</label>
                                        <select class="form-control select2" name="setor" id="setor" data-toggle="select2" onchange="sendFilter()">
                                            <option></option>
                                            <option value="2">COTEC</option>
                                            <option value="1">EFG</option>
                                            <option value="4">BASILEU</option>
                                            <option value="3">CETT</option>
                                            
                                        </select>
                                    </div>
                                </div>
             
                                <div class="col-3">
                                    <div class="mb-3">
                                        <label for="simpleinput" class="form-label">Status:</label>
                                        <select class="form-control select2" name="status" id="status" data-toggle="select2" onchange="sendFilter()">
                                            <option></option>
                                            <option value="1">Em Análise</option>
                                            <option value="2">Em Produção</option>
                                            <option value="3">Concluída</option>
                                            <option value="4">Devolvida</option>
                                            <option value="5">Cancelada</option>
                                            
                                        </select>
                                    </div>
                                </div>
                            </div>
                                </form>
                                <div class="table-responsive-sm">
                                    <table class="table table-centered mb-0">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>ID</th>
                                                <th>Título</th>
                                                <th>Data da Solicitação</th>
                                                <th>Prazo de Entrega</th>
                                                <th>Setor</th>
                                                <th>Solicitante</th>
                                                <th>Status</th>
                                         
                                            </tr>
                                        </thead>
                                        <tbody id="tbl_solicitacoes">
                                        {% for solicitacao in paginas %}
    
                                            <tr style="cursor: pointer;"  onclick="acessarSolicitacao('{{solicitacao.id}}')">
                                                <td>#{{solicitacao.id}}</td>
                                                <td>{{solicitacao.titulo}}</td>
                                                <td>{{solicitacao.data_solicitacao|date:'d/m/Y'}}</td>
                                                <td>{{solicitacao.prazo_entrega|date:'d/m/Y'}}</td>
                                                <td>{{solicitacao.get_projeto_display}}</td>
                                                <td>
                                                    <div id="tooltip-container3">
                                                        <img src="{% static 'layouts/assets/images/users/avatar-2.jpg' %}" alt="image" class="avatar-xs rounded-circle me-1"  > {{solicitacao.autor.first_name}}
                                                    </div>
                                                </td>
                                                {% if solicitacao.status == 1 %}
                                                <td><span class="badge badge-outline-warning rounded-pill">{{solicitacao.get_status_display}}</span></td>
                                                {% elif solicitacao.status == 2 %}
                                                <td><span class="badge badge-outline-info rounded-pill">{{solicitacao.get_status_display}}</span></td>
                                                {% elif solicitacao.status == 3 %}
                                                <td><span class="badge badge-outline-success rounded-pill">{{solicitacao.get_status_display}}</span></td>
                                                {% elif solicitacao.status == 4 or solicitacao.status == 5 %}
                                                <td><span class="badge badge-outline-danger rounded-pill">{{solicitacao.get_status_display}}</span></td>
                                                {% endif %}
                                            </tr>
                                        {% endfor %}
                                        
                                      
                                        </tbody>
                                    </table><br>
                                    <nav aria-label="Page navigation example">
                                        <ul class="pagination">
                                          {% if paginas.has_previous %}
                                          <li class="page-item">
                                            <a class="page-link" href="?pagina=1">&laquo; Primeiro</a>
                                          </li>
                                            <li class="page-item">
                                              
                                              <a class="page-link" href="?pagina={{ paginas.previous_page_number }}">Anterior</a>
                                            </li>
                                          {% else %}
                                            <li class="page-item disabled">
                                              <a class="page-link" href="#" tabindex="-1" aria-disabled="True">Anterior</a>
                                            </li>
                                          {% endif %}
                        
                                              <li class="page-item active" aria-current="page">
                                                <span class="page-link">{{ paginas.number }} de {{ paginas.paginator.num_pages }}</span>
                                              </li>
                                           
                                          {% if paginas.has_next %}
                                         
                                            <li class="page-item">
                                              <a class="page-link" href="?pagina={{ paginas.next_page_number }}">Próximo</a>
                                            </li>
                                            <li class="page-item">
                                              <a class="page-link" href="?pagina={{ paginas.paginator.num_pages }}">Último &raquo;</a>
                                            </li>
                                          {% else %}
                                            <li class="page-item disabled">
                                              <a class="page-link" href="#" tabindex="-1" aria-disabled="True">Próximo</a>
                                            </li>
                                          {% endif %}
                                        </ul>
                                      </nav>
                                </div>
                            </div> <!-- end card-body-->
                        </div> <!-- end card-->
                    </div>

                </div> <!-- end col-->
            </div>
            <!-- end row -->

        </div> <!-- container -->

    </div> <!-- content -->

    <!-- Footer Start -->
    <footer class="footer">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-6">
                    <script>document.write(new Date().getFullYear())</script> © CETT - Comunicação
                </div>
                <div class="col-md-6">
                    <div class="text-md-end footer-links d-none d-md-block">
                        <a href="javascript: void(0);">About</a>
                        <a href="javascript: void(0);">Support</a>
                        <a href="javascript: void(0);">Contact Us</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <!-- end Footer -->

</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>

function RealizaSolicitacao(){
    var form = document.getElementById("form_solicitacao");
    var formData = new FormData(form);  // Use FormData para incluir campos de arquivo]

    var fileInput = document.getElementById('fileInput');
    
    if (fileInput){
      for (var i = 0; i < fileInput.files.length; i++) {
        console.log(fileInput.files[i])
        formData.append('files[]', fileInput.files[i]);
    }
    }

    console.log(formData)
    Swal.fire({
        title: 'Realizar Solicitação?',
        text: 'Deseja realmente realizar esta solicitação? Caso realize não poderá alterar até que a solicitação seja devolvida',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sim',
        cancelButtonText: 'Não'
    }).then((result) => {
        if (result.isConfirmed) {
            var XCSRFToken = '{{ csrf_token }}';
            const url = "/realizar-solicitacao";
            
            // Use a função $.ajax do jQuery para fazer a solicitação AJAX
            $.ajax({
                url: url,
                type: "POST",
                data: formData,
                headers: { "X-CSRFToken": XCSRFToken },
                processData: false,  // Não processar os dados (o FormData já cuida disso)
                contentType: false,  // Não definir o tipo de conteúdo (o FormData já cuida disso)
                success: function (data) {
                  $("#tbl_solicitacoes").html(data);
                    Swal.fire({
                        icon: 'success',
                        title: 'Solicitação Realizada!',
                        text: "A solicitação foi realizada com sucesso!"
                    }).then((result) => {
                        // Ação a ser realizada após o botão "OK" ser clicado
                        if (result.isConfirmed) {
                           
                           
                        }
                    });
                },
                error: function (data) {
                    console.log(data)
                    if (data.responseJSON && data.responseJSON.error_message) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Ops!',
                            text: data.responseJSON.error_message
                        });
                    }
                }
            });
        }
    });
}

$(document).ready(function() {
  $('#summernote').summernote(
    {
  toolbar: [
    ['style', ['bold', 'italic', 'underline', 'clear']],
    ['font', ['strikethrough', 'superscript', 'subscript']],
    ['para', ['ul', 'ol']],

    // Outras opções de toolbar que você deseja incluir, mas sem 'link'
  ],
  // Outras configurações necessárias para o seu uso
}
  );
});

function showSelectedFiles() {
            const fileInput = document.getElementById('fileInput');
            const fileDisplay = document.getElementById('fileDisplay');

            // Limpa a exibição de arquivos anteriores
            fileDisplay.innerHTML = "";

            const files = fileInput.files;
            for (let i = 0; i < files.length; i++) {
                const fileName = files[i].name;
                const listItem = document.createElement('div');
                listItem.className = "col-auto";
                listItem.innerHTML = `
                    <i class="file-icon ri-upload-cloud-line me-1"></i>
                    <span style="font-size: 16px;">${fileName}</span>
                    <i class="remove-button ri-indeterminate-circle-fill" onclick="removeFile(${i})" style="cursor: pointer; color: red; font-size: 20px;"	></i>
                `;
                fileDisplay.appendChild(listItem);
            }
        }

function removeFile(index) {
    const fileInput = document.getElementById('fileInput');
    const files = Array.from(fileInput.files);
    files.splice(index, 1);

    // Cria um novo input de arquivo e copia os arquivos restantes
    const newFileInput = document.createElement('input');
    newFileInput.type = 'file';
    newFileInput.id = 'fileInput';
    newFileInput.multiple = true;
    newFileInput.style.display = 'none';
    newFileInput.addEventListener('change', showSelectedFiles);

    const dataTransfer = new DataTransfer();
    files.forEach(file => dataTransfer.items.add(file));
    newFileInput.files = dataTransfer.files;

    // Substitui o input de arquivo anterior
    fileInput.parentNode.replaceChild(newFileInput, fileInput);

    // Atualize a lista de arquivos selecionados
    showSelectedFiles();
}

document.addEventListener("DOMContentLoaded", function() {
        // Obtém o campo de data
        const idSolicitacao = document.getElementById("idSolicitacao");
        const dataSolicitacao = document.getElementById("data_solicitacao");

        // Adiciona um ouvinte de evento ao campo de data para detectar mudanças
        idSolicitacao.addEventListener("input", function() {
            setTimeout(function() {
                sendFilter();
            }, 2000);
        });

        dataSolicitacao.addEventListener("input", function() {
            setTimeout(function() {
                sendFilter();
            }, 2000);
        });


    });

function sendFilter(){
   
      var form = document.getElementById("formFilters");
      var formData = new FormData(form);
      var url = '/filter-solicitacoes';
      // Adiciona manualmente os valores dos campos do formulário ao objeto formData
      // formData.append("campo_extra", "valor_extra");

      // Converte o objeto formData em uma string no formato de consulta GET $("#resultados_concluidos").html(data);
      var queryString = new URLSearchParams(formData).toString();

      // Concatena a string de consulta GET à URL
      url += "?" + queryString;

      $.ajax({
          url: url,
          type: 'GET',
          success: function(data) {
              $("#tbl_solicitacoes").html(data);
              
          },
          error: function(xhr, status, error) {
              Swal.fire({
                  icon: 'error',
                  title: 'Ops!',
                  text: 'Não foi possível obter resultados!'
              });
          }
      });



    }

function acessarSolicitacao(solicitacaoId){
        window.location.href = "/timeline/" + solicitacaoId;
    }


</script>
{% endblock %}